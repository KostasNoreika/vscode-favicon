<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Badge Injection Performance Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .results {
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .winner {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        .preview {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .preview-item {
            text-align: center;
        }
        .preview-item svg {
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .metric {
            display: inline-block;
            margin: 10px 15px;
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        .metric strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <h1>SVG Badge Injection Performance Test</h1>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>This test compares the performance of two approaches for injecting a notification badge into SVG favicons:</p>
        <ul>
            <li><strong>OLD Method:</strong> DOMParser + XMLSerializer (DOM manipulation)</li>
            <li><strong>NEW Method:</strong> String replace operations (regex-based)</li>
        </ul>
        <p>Each test runs 1,000 iterations to get accurate timing measurements.</p>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results" class="results">
            Click "Run All Tests" to start performance testing...
        </div>
    </div>

    <div class="test-section">
        <h2>Visual Comparison</h2>
        <div class="preview" id="preview">
            <div class="preview-item">
                <h3>Original SVG</h3>
                <div id="original-svg"></div>
            </div>
            <div class="preview-item">
                <h3>OLD Method (DOMParser)</h3>
                <div id="old-method-svg"></div>
            </div>
            <div class="preview-item">
                <h3>NEW Method (String Replace)</h3>
                <div id="new-method-svg"></div>
            </div>
        </div>
    </div>

    <script>
        // Sample SVG favicon (similar to what the extension generates)
        const sampleSVG = `<svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
    <rect width="32" height="32" rx="4" fill="#4ECDC4"/>
    <text x="16" y="21" text-anchor="middle" fill="white" font-family="Arial" font-size="14" font-weight="bold">
        VS
    </text>
</svg>`;

        // OLD METHOD: DOMParser + XMLSerializer
        function addNotificationBadgeOLD(svgContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svg = doc.querySelector('svg');

            if (svg) {
                // Add CSS animation style
                const defs = doc.createElementNS('http://www.w3.org/2000/svg', 'defs');
                defs.innerHTML = `
                    <style>
                        @keyframes strongPulse {
                            0%, 100% {
                                opacity: 1;
                                transform: scale(1);
                            }
                            50% {
                                opacity: 0.3;
                                transform: scale(0.95);
                            }
                        }
                        .badge-group {
                            animation: strongPulse 1s ease-in-out infinite;
                            transform-origin: 24px 8px;
                        }
                    </style>
                `;
                svg.insertBefore(defs, svg.firstChild);

                // Create badge
                const badge = doc.createElementNS('http://www.w3.org/2000/svg', 'g');
                badge.setAttribute('class', 'badge-group');
                badge.innerHTML = `
                    <circle cx="24" cy="8" r="9" fill="#FF0000" stroke="white" stroke-width="2"/>
                    <circle cx="24" cy="8" r="4" fill="white"/>
                `;
                svg.appendChild(badge);

                // Serialize back to string
                const serializer = new XMLSerializer();
                return serializer.serializeToString(svg);
            }

            return svgContent;
        }

        // NEW METHOD: String Replace (OPTIMIZED)
        function addNotificationBadgeNEW(svgContent) {
            const badgeDefs = `
                <style>
                    @keyframes strongPulse {
                        0%, 100% {
                            opacity: 1;
                            transform: scale(1);
                        }
                        50% {
                            opacity: 0.3;
                            transform: scale(0.95);
                        }
                    }
                    .badge-group {
                        animation: strongPulse 1s ease-in-out infinite;
                        transform-origin: 24px 8px;
                    }
                </style>
            `;

            const badgeGroup = `
            <g class="badge-group">
                <circle cx="24" cy="8" r="9" fill="#FF0000" stroke="white" stroke-width="2"/>
                <circle cx="24" cy="8" r="4" fill="white"/>
            </g>`;

            // Fast string operations
            let result = svgContent.replace(
                /(<svg[^>]*>)/i,
                `$1<defs>${badgeDefs}</defs>`
            );

            result = result.replace(
                /<\/svg>/i,
                `${badgeGroup}</svg>`
            );

            return result;
        }

        // Performance testing function
        function measurePerformance(fn, iterations = 1000) {
            const start = performance.now();

            for (let i = 0; i < iterations; i++) {
                fn(sampleSVG);
            }

            const end = performance.now();
            const totalTime = end - start;
            const avgTime = totalTime / iterations;

            return {
                totalTime: totalTime.toFixed(2),
                avgTime: avgTime.toFixed(4),
                iterations
            };
        }

        // Run all performance tests
        function runAllTests() {
            const iterations = 1000;

            console.log('Starting performance tests...');

            // Test OLD method
            const oldResults = measurePerformance(addNotificationBadgeOLD, iterations);

            // Test NEW method
            const newResults = measurePerformance(addNotificationBadgeNEW, iterations);

            // Calculate improvement
            const speedup = (parseFloat(oldResults.avgTime) / parseFloat(newResults.avgTime)).toFixed(2);
            const timeSaved = (parseFloat(oldResults.avgTime) - parseFloat(newResults.avgTime)).toFixed(4);
            const percentImprovement = (((parseFloat(oldResults.avgTime) - parseFloat(newResults.avgTime)) / parseFloat(oldResults.avgTime)) * 100).toFixed(1);

            // Display results
            const resultsHTML = `
                <h3>Performance Results (${iterations} iterations)</h3>

                <div class="metric">
                    <strong>OLD Method (DOMParser):</strong><br>
                    Total: ${oldResults.totalTime}ms | Avg: ${oldResults.avgTime}ms per operation
                </div>

                <div class="metric">
                    <strong>NEW Method (String Replace):</strong><br>
                    Total: ${newResults.totalTime}ms | Avg: ${newResults.avgTime}ms per operation
                </div>

                <div class="winner">
                    Performance Improvement: ${speedup}x faster (${percentImprovement}% improvement)<br>
                    Time saved per operation: ${timeSaved}ms<br>
                    Time saved per ${iterations} operations: ${(parseFloat(oldResults.totalTime) - parseFloat(newResults.totalTime)).toFixed(2)}ms
                </div>

                <h4>Detailed Analysis:</h4>
                <ul>
                    <li>OLD Method creates DOM tree, manipulates nodes, serializes back to string</li>
                    <li>NEW Method uses simple regex replacements (no DOM parsing overhead)</li>
                    <li>Target was <1ms per operation (NEW method: ${newResults.avgTime}ms)</li>
                    <li>${parseFloat(newResults.avgTime) < 1 ? '✅ TARGET ACHIEVED!' : '⚠️ Target not quite met, but significant improvement'}</li>
                </ul>
            `;

            document.getElementById('results').innerHTML = resultsHTML;

            // Update visual preview
            document.getElementById('original-svg').innerHTML = sampleSVG;
            document.getElementById('old-method-svg').innerHTML = addNotificationBadgeOLD(sampleSVG);
            document.getElementById('new-method-svg').innerHTML = addNotificationBadgeNEW(sampleSVG);

            console.log('Tests completed!');
            console.log('OLD Method:', oldResults);
            console.log('NEW Method:', newResults);
            console.log('Speedup:', speedup + 'x');
        }

        // Initial preview with original SVG
        window.addEventListener('load', () => {
            document.getElementById('original-svg').innerHTML = sampleSVG;
        });
    </script>
</body>
</html>
